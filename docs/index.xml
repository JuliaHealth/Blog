<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>The JuliaHealth Blog</title>
<link>https://juliahealth.org/JuliaHealthBlog/</link>
<atom:link href="https://juliahealth.org/JuliaHealthBlog/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.5.47</generator>
<lastBuildDate>Sat, 07 Sep 2024 04:00:00 GMT</lastBuildDate>
<item>
  <title>GSoC ’24: Developing Tooling for Observational Health Research in Julia</title>
  <dc:creator>Jay Sanjay Landge</dc:creator>
  <link>https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/gsoc-2024-fellows.html</link>
  <description><![CDATA[ 




<section id="hi-everyone" class="level1">
<h1>Hi Everyone! 👋</h1>
<p>I am Jay Sanjay, and I am pursuing a Bachelor’s degree in Computational Sciences and Engineering at the Indian Institute of Technology (IIT) in Hyderabad, India. Coming from a mathematics and data analysis background, I was initially introduced to Julia at my university lectures. Later, I delved more into the language and the JuliaHealth community - an intersection of Julia, Health Research, Data Sciences, and Informatics. Here, I met some of the great folks in JuliaHealth and I decided to take it on as a full-fledged summer project. In this blog, I will briefly describe what my project is and what I did as a part of it.</p>
<blockquote class="blockquote">
<p>If you want to know more about me, you can connect with me on <a href="https://www.linkedin.com/in/jay-landge-589439260/"><strong>LinkedIn</strong></a> and follow me on <a href="https://github.com/Jay-sanjay"><strong>GitHub</strong></a></p>
</blockquote>
</section>
<section id="background" class="level1">
<h1>Background</h1>
<section id="what-is-observational-health-research" class="level2">
<h2 class="anchored" data-anchor-id="what-is-observational-health-research">What Is Observational Health Research?</h2>
<p>Observational Health Research refers to studies that analyze real-world data (such as patient medical claims, electronic health records, etc.) to understand patient health. These studies often encompass a vast amount of data concerning patient care. An outstanding challenge here is that these datasets can become very complex and grow large enough to require advanced computing methods to process this information.</p>
</section>
<section id="what-are-patient-pathways" class="level2">
<h2 class="anchored" data-anchor-id="what-are-patient-pathways">What Are Patient Pathways?</h2>
<p>Patient pathways refer to the journey that patients with specific medical conditions undergo in terms of their treatment. This concept goes beyond simple drug uptake statistics and looks at the sequence of treatments patients receive over time, including first-line treatments and subsequent therapies. Understanding patient pathways is essential for analyzing treatment patterns, adherence to clinical guidelines, and the disbursement of drugs. To analyze patient pathways, one would typically use real-world data from sources such as electronic health records, claims data, and registries. However, barriers such as data interoperability and resource requirements have hindered the full utilization of real-world data for this purpose.</p>
<p>So to address these challenges we (the JuliaHealth organization and I) want to develop a set of tools to extract and analyze these patient pathways. These sets of tools are based on the Observational Medical Outcomes Partnership (OMOP) Common Data Model, which standardizes healthcare data to promote interoperability.</p>
</section>
</section>
<section id="project-description" class="level1">
<h1>Project Description</h1>
<p>As part of this project with JuliaHealth, I developed a new package called <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl"><strong>OMOPCDMPathways.jl</strong></a>. This package is designed for deployment in research projects, particularly those related to health and medical data analysis. This project takes much inspiration from the paper <a href="https://www.sciencedirect.com/science/article/pii/S016926072200462X?via%3Dihub"><em>TreatmentPatterns: An r package to facilitate the standardized development and analysis of treatment patterns across disease domains</em></a> <span class="citation" data-cites="markus2022treatmentpatterns">[1]</span> and explores the implementation of some of those ideas to develop new tools within the JuliaHealth Observational Health Subecosystem for exploring patient pathways. Additional new features and approaches were added and explored within this project. Additionally, I have authored a developer guide for the package, providing instructions on its use and contribution. This project provided me with hands-on experience in developing production-level code and exposed me to open-source software development practices. I had the opportunity to work in a team, under my mentors, and ensured the integration of the package with the rest of JuliaHealth, facilitating its adoption and usability within the community.</p>
</section>
<section id="project-goals" class="level1">
<h1>Project Goals</h1>
<p>As a part of the development, I was majorly engaged in crafting the following functionalities:</p>
<ol type="1">
<li><p>Selecting treatments of interest: The first decision that was made was to decide the time from which the desired treatments of interest should be included in the treatment pathway study. Here the <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/issues/1">periodPriorToIndex</a> specifies the period (i.e.&nbsp;number of days) before the index date from which treatments should be included.</p></li>
<li><p>Find Treatment History of Patients: Create the <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/issues/4">treatment history</a> of a patient based on target, event, and exit cohorts. Then filter patient events based on the start and end dates of the target cohort. Third, Calculate the duration of treatment eras and the gap between treatments.</p></li>
<li><p>Filters: Filter the treatment history based on the <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/issues/5">minEraDuration</a> parameter and <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/issues/2">EraCollapse</a> parameter.</p></li>
<li><p>Create a Continuous Integration and Continuous Development pipeline for the package.</p></li>
<li><p>Implement the combinationWindow function, which combines treatments with various overlapping strategies.</p></li>
</ol>
<p>Additionally, we had a few stretch goals which were:</p>
<ol type="1">
<li><p>Composing with JuliaStats Ecosystem</p></li>
<li><p>Novel Visualizations for Pathways</p></li>
</ol>
</section>
<section id="tasks" class="level1">
<h1>Tasks</h1>
<section id="setting-up-the-package-in-juliahealth-channel" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-package-in-juliahealth-channel">1. Setting Up the Package in JuliaHealth Channel</h2>
<p>Initially, there was no package as such for generating pathways, so I had to build it from scratch. First, I created the repository with the name <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl">OMOPCDMPathways.jl</a>. Once the repository was created, we needed to have a skeleton for a standard Julia repository. For this, we used the <a href="https://juliaci.github.io/PkgTemplates.jl/stable/user/">PkgTemplates.jl</a> this provided a basic skeleton for the repository that included - folders for test suites, documentation, src code files, GitHub files, README and LICENSE file, TOML and citation files. All this we can further edit and modify as per our work. By default, PkgTemplate.jl uses <a href="https://documenter.juliadocs.org/stable/">Documenter.jl</a> for the documentation part but as suggested and discussed with my mentor we decided to shift to <a href="https://luxdl.github.io/DocumenterVitepress.jl/dev/">DocumenterVitepress.jl</a> for the documentation part. However, we still faced some deployment issues in the new documentation due to a few mistakes in the <code>make.jl</code> file, thanks to <a href="https://github.com/asinghvi17">Anshul Singhvi</a> for helping fix the <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/issues/15">Deployment issues with DocumenterVitepress</a>. With this, we were ready with the documentation set up and fully functional. After we had shifted to DocumenterVitepress the main task now was to host the documentation, this was done using Github-Actions, detailed steps for hosting are provided at <a href="https://documenter.juliadocs.org/stable/man/hosting/#Hosting-Documentation">this</a> page. Then we added the CodeCov to our package by triggering it via a dummy function and a corresponding test case for it. Also, the CI for the package was set up with it. And, now finally the repository was ready with test coverage, CI, and documentation fully functional repository ready. Here’s some snapshots of the documentation set-up:</p>
<p><img src="https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/image.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>Initial documentation with Documenter.jl</p>
</blockquote>
<p><img src="https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/img2.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>New documentation using DocumenterVitepress.jl</p>
</blockquote>
<p>So, as a part of it, I created this <a href="https://luxdl.github.io/DocumenterVitepress.jl/dev/documenter_to_vitepress_docs_example">documentation</a> which provides detailed steps for converting docs from Documenter to DocumenterVitepress.</p>
</section>
<section id="loading-the-postgresql-database" class="level2">
<h2 class="anchored" data-anchor-id="loading-the-postgresql-database">2. Loading the PostgreSQL Database</h2>
<p>The main database we worked on/built analysis was the freely available OMOPCDM Database. The Database was formatted within a PostgreSQL database with <a href="https://www.devart.com/dbforge/postgresql/how-to-install-postgresql-on-linux/">installation instructions here</a> are some instructions on how to set up Postgres in a Linux machine. However, I was provided with some more extra synthetic data from my mentor for further testing of the functionalities. Being a very large database we had to strategically download it further, my mentor helped me in setting up the Postgres on my local machine. Once, the database was set up proper testing was performed on it to check if things were as expected. With this, we were done with the database setup as well and could finally dive into the actual code logic for the Pathways synthesis.</p>
</section>
<section id="testing-and-development-setup-on-my-local-computer" class="level2">
<h2 class="anchored" data-anchor-id="testing-and-development-setup-on-my-local-computer">3. Testing and Development setup on my local computer</h2>
<p>To get a proper environment for functionality creation and concurrent testing we required a proper testing setup so that we could test the new functions made at the same time. This was done using <a href="https://timholy.github.io/Revise.jl/stable/">Revise.jl</a>, which helps to keep Julia sessions running without frequent restarts when making changes to code. It allowed me to edit my code, update packages, or switch git branches during a session, with changes applied immediately in the next command. My mentor helped me set it up, added Revise.jl to the global Julia environment, also <a href="https://github.com/GunnarFarneback/PackageCompatUI.jl">PackageCompatUI</a> that provides a terminal text interface to the [compat] section of a Julia Project.toml file, and finally made a Julia script by the name “startup.jl” out of it. This script was then added to <code>/home/jay-sanjay/.julia/config/</code> path in my local computer.</p>
<p>Here is the sample for the startup.jl file:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">PackageCompatUI</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">PkgTemplates</span></span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Revise</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">###################################</span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># HELPER FUNCTIONS</span></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">###################################</span></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">template</span>()</span>
<span id="cb1-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Template</span>(;</span>
<span id="cb1-10">        user<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jay-sanjay"</span>,</span>
<span id="cb1-11">        dir<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/FOSS"</span>,</span>
<span id="cb1-12">        authors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jaysanjay &lt;jaysanjay@gmail.com&gt; and contributors"</span>,</span>
<span id="cb1-13">        julia<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">v"1.6"</span>,</span>
<span id="cb1-14">        plugins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb1-15">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ProjectFile</span>(; version<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">v"0.0.1"</span>),</span>
<span id="cb1-16">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Git</span>(),</span>
<span id="cb1-17">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Readme</span>(),</span>
<span id="cb1-18">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">License</span>(; name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"MIT"</span>),</span>
<span id="cb1-19">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GitHubActions</span>(; extra_versions<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1.6"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nightly"</span>]),</span>
<span id="cb1-20">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">TagBot</span>(),</span>
<span id="cb1-21">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Codecov</span>(),</span>
<span id="cb1-22">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Documenter</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">{GitHubActions}</span>(),</span>
<span id="cb1-23">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Citation</span>(; readme <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>),</span>
<span id="cb1-24">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">RegisterAction</span>(),</span>
<span id="cb1-25">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">BlueStyleBadge</span>(),</span>
<span id="cb1-26">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Formatter</span>(;style <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>)</span>
<span id="cb1-27">        ],</span>
<span id="cb1-28">    )</span>
<span id="cb1-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div>
</section>
<section id="selecting-treatments-of-interest" class="level2">
<h2 class="anchored" data-anchor-id="selecting-treatments-of-interest">4. Selecting Treatments of Interest</h2>
<p>So, as a part of this, we used the previously mentioned research paper and discussion with the mentors we came up with logic for it. The first thing to do was to determine the moment in time from which selected treatments of interest should be included in the treatment pathway. The default is all treatments starting after the index date of the target cohort. For example, for a target cohort consisting of newly diagnosed patients, treatments after the moment of first diagnosis are included. However, it would also be desirable to include (some) treatments before the index date, for instance in case a specific disease diagnosis is only confirmed after initiating treatment. Therefore, periodPriorToIndex specifies the period (i.e.&nbsp;number of days) before the index date from which treatments should be included. We have created two dispatches for this function. After that proper testing and documentation are also added.</p>
<p>A basic implementation for it is:</p>
<ol type="1">
<li><p>Construct a SQL query to select cohort_definition_id, subject_id, and cohort_start_date from a specified table, filtering by cohort_id.</p></li>
<li><p>The SQL query construction and execution was done using the <a href="https://mechanicalrabbit.github.io/FunSQL.jl/stable/">FunSQL.jl</a> library, in the below-shown manner:</p></li>
</ol>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb2-1">sql <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">From</span>(tab) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-2">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Where</span>(Fun.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">in</span>(Get.cohort_definition_id, cohort_id<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-3">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Select</span>(Get.cohort_definition_id, Get.subject_id, Get.cohort_start_date) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-4">            q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">render</span>(q, dialect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dialect)</span></code></pre></div>
<ol start="3" type="1">
<li><p>Executes the constructed SQL query using a database connection, fetching the results into a data frame.</p></li>
<li><p>If the DataFrame is not empty, convert cohort_start_date to DateTime and subtract date_prior from each date, then return the modified DataFrame.</p></li>
</ol>
<p>This was then be called this:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">period_prior_to_index</span>(</span>
<span id="cb3-2">        cohort_id <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb3-3">        conn; </span>
<span id="cb3-4">        date_prior <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Day</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), </span>
<span id="cb3-5">        tab<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cohort</span>
<span id="cb3-6">    )</span></code></pre></div>
</section>
<section id="filters-applied" class="level2">
<h2 class="anchored" data-anchor-id="filters-applied">5. Filters Applied</h2>
<p>After this, we where needed to get the patient’s database filtered more finely so that there are minimal variations that can be ignored. The duration of the above extracted event eras may vary a lot and it can be preferable to limit to only treatments exceeding a minimum duration. Hence, minEraDuration speciﬁes the minimum time an event era should last to be included in the analysis. All these implementations were more of Dataframe manipulation where I used <a href="https://dataframes.juliadata.org/stable/">DataFrames.jl</a> package.</p>
<p>After that proper testing and documentation are also added.</p>
<p>A basic implementation for the minEraDuration is: It filters the treatment history <code>DataFrame</code> to retain only those rows where the duration between <code>drug_exposure_end</code> and <code>drug_exposure_start</code> is at least <code>minEraDuration</code>. This function can be used as follows:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| eval: false </span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_era_duration</span>(test_df, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">920000</span>)</span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#= ... =#</span></span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">×</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> DataFrame</span>
<span id="cb4-8"> Row │ person_id  drug_exposure_start  drug_exposure_end </span>
<span id="cb4-9">     │ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int64</span>      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>              <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int64</span>             </span>
<span id="cb4-10">─────┼───────────────────────────────────────────────────</span>
<span id="cb4-11">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.7273e8</span>          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">364953600</span></span>
<span id="cb4-12">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.90304e7</span>           <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">31449600</span></span>
<span id="cb4-13">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.18208e7</span>          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80006400</span></span>
<span id="cb4-14">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.32918e9</span>         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1330387200</span></span></code></pre></div>
<p>Another filter we worked on is the EraCollapse. So, let’s suppose a case where an individual receives the same treatment for a long period of time (e.g.&nbsp;need for chronic treatment). Then it’s highly likely that the person would require refills. Now as patients are not 100% adherent, there might be a gap between two subsequent event eras. Usually, these eras are still considered as one treatment episode, and the eraCollapseSize deals with the maximum gap within which two eras of the same event cohort would be collapsed into one era (i.e.&nbsp;seen as a continuous treatment instead of a stop and re-initiation of the same treatment). After that proper testing and documentation are also added.</p>
<p>A basic implementation for the eraCollapseSize is: (a) Sorts the data frame by event_start_date and event_end_date. (b) Calculates the gap between each era and the previous era. (c) Filters out rows with gap_same &gt; eraCollapseSize.</p>
<p>These functions can be used as follows:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| eval: false </span></span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#= ... =#</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EraCollapse</span>(treatment_history <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> test_df, eraCollapseSize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">400000000</span>)</span>
<span id="cb5-6"><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">×</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> DataFrame</span>
<span id="cb5-7"> Row │ person_id  drug_exposure_start  drug_exposure_end  gap_same   </span>
<span id="cb5-8">     │ <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int64</span>      <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>              <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int64</span>              <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>    </span>
<span id="cb5-9">─────┼───────────────────────────────────────────────────────────────</span>
<span id="cb5-10">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.33347e8</span>         <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">532483200</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.86373e9</span></span>
<span id="cb5-11">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.7273e8</span>          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">364953600</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.59754e8</span></span>
<span id="cb5-12">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>           <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8.18208e7</span>          <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">80006400</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.83133e8</span></span>
<span id="cb5-13">   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> │         <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>            <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.90304e7</span>           <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">31449600</span>   <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.09037e8</span></span></code></pre></div>
</section>
<section id="treatment-history-of-the-patients" class="level2">
<h2 class="anchored" data-anchor-id="treatment-history-of-the-patients">6. Treatment History of the Patients</h2>
<p>The <code>create_treatment_history</code> function constructs a detailed treatment history for patients in a target cohort by processing and filtering event cohort data from a given DataFrame. It begins by isolating the target cohort based on its <code>cohort_id</code>, adding a new column for the <code>index_year</code> derived from the cohort’s start date. Then, it selects relevant event cohorts based on a provided list of cohort IDs and merges them with the target cohort on the <code>subject_id</code> to associate events with individuals in the target group. The function applies different filtering criteria depending on whether the user is interested in treatments starting or ending within a specified period before the target cohort’s start date (defined by <code>periodPriorToIndex</code>). It keeps only the event cohorts that match the filtering condition, ensuring that only relevant treatments are considered. After filtering, the function calculates time gaps between consecutive cohort events for each patient, adding these gaps to the DataFrame. The final DataFrame provides a history of treatments, including the dates of events and the time intervals between them, offering a clear timeline of treatment for each patient. After that proper testing and documentation are also added.</p>
</section>
<section id="combinationwindow-functionality-to-combine-overlapping-treatments" class="level2">
<h2 class="anchored" data-anchor-id="combinationwindow-functionality-to-combine-overlapping-treatments">7. CombinationWindow Functionality To Combine Overlapping Treatments</h2>
<p>Now once we have the filtering of the treatments done, we need to combine the overlapping treatments based on some set of rules. The combinationWindow specifies the time that two event eras need to overlap to be considered a combination treatment. If there are more than two overlapping event eras, we sequentially combine treatments, starting from the ﬁrst two overlapping event eras.</p>
<p>The <code>combination_Window</code> function processes a patient’s treatment history by identifying overlapping treatment events and combining them into continuous treatment periods based on certain rules. It first converts <code>event_cohort_id</code> into strings and sorts the treatment data by <code>person_id</code>, <code>event_start_date</code>, and <code>event_end_date</code>. The helper function <code>selectRowsCombinationWindow</code> calculates gaps between consecutive treatments, marking rows where treatments overlap or occur too closely. In the main loop, the function checks these overlaps and gaps against a specified <code>combinationWindow</code>. If treatments overlap (or nearly overlap), the function adjusts the treatment periods by either merging adjacent rows or splitting rows to create continuous treatment periods. The process continues until all overlapping treatments are combined into one, creating an updated and accurate treatment history. The function ensures the final output reflects realistic treatment windows by handling special cases where gaps between treatments are smaller than the treatment durations themselves.</p>
<p>It mainly covers the three cases mentioned in the R-research paper:</p>
<section id="switch-case" class="level3">
<h3 class="anchored" data-anchor-id="switch-case">Switch Case:</h3>
<p><em>Condition</em>: If the gap between the two treatment events is smaller than the combinationWindow, but the gap is not equal to the duration of either event. <em>Action</em>: The event_end_date of the previous treatment is set to the event_start_date of the current treatment. This effectively “shifts” the previous treatment’s end date to eliminate the gap, merging the treatments into one continuous period. <em>Purpose</em>: This ensures that treatment gaps that are too small (less than combinationWindow) are treated as part of the same treatment window.</p>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| eval: false </span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#= ... =#</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gap_previous <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> combinationWindow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> !(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gap_previous <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [duration_era, prev_duration_era])</span>
<span id="cb6-6">    treatment_history[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>event_end_date] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> treatment_history[i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>event_start_date]</span></code></pre></div>
<p>Here is the pictorial representation for the same: <img src="https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/case1.png" class="img-fluid"></p>
</section>
<section id="frfs-first-row-first-shortened" class="level3">
<h3 class="anchored" data-anchor-id="frfs-first-row-first-shortened">FRFS (First Row, First Shortened):</h3>
<p><em>Condition</em>: If the gap is larger than or equal to the combinationWindow, or the gap equals the duration of one of the two treatments, and the first treatment ends before or on the same date as the second treatment. <em>Action</em>: A new row is created where the second treatment’s event_end_date is set to the end date of the first treatment. This preserves the overlap but ensures that the earlier treatment period stays intact. <em>Purpose</em>: This prevents unnecessary truncation of the first treatment if it spans the entire overlap window.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| eval: false </span></span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#= ... =#</span></span>
<span id="cb7-4"></span>
<span id="cb7-5">elseif <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gap_previous <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> combinationWindow <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gap_previous <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> [duration_era, prev_duration_era]</span>
<span id="cb7-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> treatment_history[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>event_end_date] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> treatment_history[i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>event_end_date]</span>
<span id="cb7-7">        new_row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deepcopy</span>(treatment_history[i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>])</span>
<span id="cb7-8">        new_row.event_end_date <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> treatment_history[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>event_end_date]</span>
<span id="cb7-9">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">append!</span>(treatment_history, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">DataFrame</span>(new_row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span>))</span></code></pre></div>
<p>Here is the pictorial representation for the same: <img src="https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/case2.png" class="img-fluid"></p>
</section>
<section id="lrfs-last-row-first-shortened" class="level3">
<h3 class="anchored" data-anchor-id="lrfs-last-row-first-shortened">LRFS (Last Row, First Shortened):</h3>
<p><em>Condition</em>: If the gap is larger than or equal to the combinationWindow, or the gap equals the duration of one of the treatments, and the first treatment ends after the second treatment. <em>Action</em>: The current treatment’s event_end_date is adjusted to match the event_end_date of the previous treatment. <em>Purpose</em>: This handles cases where the second treatment’s window should be shortened to prevent overlap with the previous treatment, merging them into a single continuous window.</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| eval: false </span></span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#= ... =#</span></span>
<span id="cb8-4"></span>
<span id="cb8-5">else</span>
<span id="cb8-6">    treatment_history[i, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>event_end_date] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> treatment_history[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>event_end_date]</span></code></pre></div>
<p>Here is the pictorial representation for the same: <img src="https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/case3.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p><em>Note:</em> However, There are a few things left to cover here, most of which are the documentation and writing the test suite for the same.</p>
</blockquote>
</section>
</section>
</section>
<section id="contributions-beyond-coding" class="level1">
<h1>Contributions Beyond Coding</h1>
<section id="organizing-meetings-and-communication" class="level2">
<h2 class="anchored" data-anchor-id="organizing-meetings-and-communication">1. Organizing Meetings and Communication</h2>
<p>Throughout the project, I regularly met with my mentor, [Jacob Zelko], and co-mentor, [Mounika], via weekly Zoom calls to discuss progress and seek guidance. During these meetings, we reviewed my work, identified areas where I needed help, and set clear goals for the upcoming weeks. We used Trello to organize and track these goals, ensuring that nothing was overlooked. My mentors provided detailed insights into specific technical aspects and guided me through the logic behind various functions. Outside of our scheduled meetings, they were always available for quick queries via Slack, ensuring constant support.</p>
</section>
<section id="personal-documentation" class="level2">
<h2 class="anchored" data-anchor-id="personal-documentation">2. Personal Documentation</h2>
<p>In addition to the notes from our meetings, I maintained personal documentation where I recorded every step I took, including the challenges I faced and the mistakes I made. This helped me reflect on my progress and stay organized throughout the fellowship. Following my selection for GSoC 2024, I also published a blog post on <a href="https://medium.com/@landgejay124/gsoc-24-the-julia-language-62b809bbec49">Medium</a> to share my journey and experiences with the Julia Language community.</p>
</section>
<section id="contributions-to-the-rest-of-the-juliahealth-repositories" class="level2">
<h2 class="anchored" data-anchor-id="contributions-to-the-rest-of-the-juliahealth-repositories">3. Contributions To the Rest of the JuliaHealth Repositories</h2>
<p>Earlier I have contributed a lot to the <a href="https://github.com/JuliaHealth/OMOPCDMCohortCreator.jl">OMOPCDMCohortCreator.jl</a> including adding new functionalities writing test suites, adding blogs including - <a href="https://github.com/JuliaHealth/juliahealth.github.io/pull/124">Patient Pathways within JuliaHealth</a>. Apart from that I also initiated 3 new releases of this package.</p>
</section>
</section>
<section id="conclusions-and-future-development" class="level1">
<h1>Conclusions and Future Development</h1>
<p>This project was a 350-hour large project since there were many goals to accomplish. Here is what we accomplished:</p>
<ol type="1">
<li><p>Built a new repository in JuliaHealth land dedicated especially to treatment pathways synthesis.</p></li>
<li><p>CI/CD for the Package and Documentation hosting.</p></li>
<li><p>All required basic functionalities required to build the pathways.</p></li>
<li><p>Documentation and test suites added for each.</p></li>
</ol>
<p>Future work would include:</p>
<ul>
<li><p>Finish this <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/pull/63">PR</a> test-suites and documentation are remaining for this PR.</p></li>
<li><p>Apart from that, we would need to add a <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/issues/9">function</a> that sews up all the functionalities of the package so that the user can run the complete pathways analysis by running just one function instead of running each of the functions manually.</p></li>
<li><p>Also, in the future, we would explore what statistical functionalities we would need to further explore pathways.</p></li>
<li><p>Then, we could explore how to compose JuliaHealth with packages from ecosystems like <a href="https://juliastats.org/">JuliaStats</a> and <a href="https://docs.juliadsp.org/stable/contents/">JuliaDSP</a> (for time series analysis) that are mentioned in this <a href="https://github.com/JuliaHealth/OMOPCDMPathways.jl/issues/8">PR</a>.</p></li>
<li><p>And finally work on creating novel visualizations for the Pathways. Commonly used visualizations for treatment pathways (such as sunburst or icicle plots) showing which patients fall under what treatment pathways could be developed as plotting recipes to visualize various aspects of a patient’s care pathway rapidly.</p></li>
</ul>
</section>
<section id="acknowledgements" class="level1">
<h1>Acknowledgements 🙇‍♂️</h1>
<ol type="1">
<li><p><a href="https://jacobzelko.com">Jacob S. Zelko</a>: aka, <a href="https://github.com/TheCedarPrince">TheCedarPrince</a></p></li>
<li><p>Mounika Thakkallapally</p></li>
</ol>
<p>Thank you for your continuous help and support throughout the fellowship. <em>Note: This blog post was also written with the assistance of LLM technologies to help with grammar, flow, and spelling!</em></p>


<!-- -->


</section>

<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0">
<div id="ref-markus2022treatmentpatterns" class="csl-entry">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">A. F. Markus, K. M. Verhamme, J. A. Kors, and P. R. Rijnbeek, <span>“TreatmentPatterns: An r package to facilitate the standardized development and analysis of treatment patterns across disease domains,”</span> <em>Computer Methods and Programs in Biomedicine</em>, vol. 225, p. 107081, 2022.</div>
</div>
</div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{sanjay_landge2024,
  author = {Sanjay Landge, Jay},
  title = {GSoC ’24: {Developing} {Tooling} for {Observational} {Health}
    {Research} in {Julia}},
  date = {2024-09-07},
  url = {https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/gsoc-2024-fellows.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-sanjay_landge2024" class="csl-entry quarto-appendix-citeas">
<div class="">J.
Sanjay Landge, <span>“GSoC ’24: Developing Tooling for Observational
Health Research in Julia,”</span> Sep. 07, 2024. Available: <a href="https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/gsoc-2024-fellows.html">https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/gsoc-2024-fellows.html</a></div>
</div></div></section></div> ]]></description>
  <category>gsoc</category>
  <category>sql</category>
  <category>observational health</category>
  <category>analysis</category>
  <guid>https://juliahealth.org/JuliaHealthBlog/posts/jay-gsoc/gsoc-2024-fellows.html</guid>
  <pubDate>Sat, 07 Sep 2024 04:00:00 GMT</pubDate>
</item>
<item>
  <title>GSoC ’24: Enhancements to KomaMRI.jl GPU Support</title>
  <dc:creator>Ryan Kierulf</dc:creator>
  <link>https://juliahealth.org/JuliaHealthBlog/posts/ryan-gsoc/Ryan_GSOC.html</link>
  <description><![CDATA[ 




<section id="hi" class="level1">
<h1>Hi! 👋</h1>
<p>I am Ryan, an MS student currently studying computer science at the University of Wisconsin-Madison. Looking for a project to work on this summer, my interest in high-performance computing and affinity for the Julia programming language drew me to Google Summer of Code, where I learned about this project opportunity to work on enhancing GPU support for KomaMRI.jl.</p>
<p>In this post, I’d like to summarize what I did this summer and everything I learned along the way!</p>
<blockquote class="blockquote">
<p>If you want to learn more about me, you can connect with me here: <a href="https://www.linkedin.com/in/ryan-kierulf-022062201/"><strong>LinkedIn</strong></a>, <a href="https://github.com/rkierulf"><strong>GitHub</strong></a></p>
</blockquote>
</section>
<section id="what-is-komamri" class="level1">
<h1>What is KomaMRI?</h1>
<p><a href="https://github.com/JuliaHealth/KomaMRI.jl">KomaMRI</a> is a Julia package for efficiently simulating Magnetic Resonance Imaging (MRI) acquisitions. MRI simulation is a useful tool for researchers, as it allows testing new pulse sequences to analyze the signal output and image reconstruction quality without needing to actually take an MRI, which may be time or cost-prohibitive.</p>
<p>In contrast to many other MRI simulators, KomaMRI.jl is open-source, cross-platform, and comes with an intuitive user interface (To learn more about KomaMRI, you can read the paper introducing it <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/mrm.29635">here</a>). However, being developed fairly recently, there are still new features that can be added and optimization to be done.</p>
</section>
<section id="project-goals" class="level1">
<h1>Project Goals</h1>
<p>The goals outlined by Carlos (my project mentor) and I the beginning of this summer were:</p>
<ol type="1">
<li><p>Extend GPU support beyond CUDA to include AMD, Intel, and Apple Silicon GPUs, through the packages <a href="https://github.com/JuliaGPU/AMDGPU.jl">AMDGPU.jl</a>, <a href="https://github.com/JuliaGPU/oneAPI.jl">oneAPI.jl</a>, and <a href="https://github.com/JuliaGPU/Metal.jl">Metal.jl</a></p></li>
<li><p>Create a CI pipeline to be able to test each of the GPU backends</p></li>
<li><p>Create a new kernel-based simulation method optimized for the GPU, which we expected would outperform array broadcasting</p></li>
<li><p>(Stretch Goal) Look into ways to support running distributed simulations across multiple nodes or GPUs</p></li>
</ol>
</section>
<section id="step-1-support-for-different-gpu-backends" class="level1">
<h1>Step 1: Support for Different GPU backends</h1>
<p>Previously, KomaMRI’s support for GPU acceleration worked by converting each array used within the simulation to a <code>CuArray</code>, the device array type defined in <a href="https://github.com/JuliaGPU/CUDA.jl">CUDA.jl</a>. This was done through a general <code>gpu</code> function. The inner simulation code is GPU-agnostic, as the same operations can be performed on a CuArray or a plain CPU Array. This approach is good for extensibility, as it does not require writing different simulation code for the CPU / GPU, or different GPU backends, and would only work in a language like Julia based on runtime dispatch!</p>
<p>To extend this to multiple GPU backends, all that is needed is to generalize the <code>gpu</code> function to convert to either the device types of CUDA.jl, AMDGPU.jl, Metal.jl, or oneAPI.jl, depending on which backend is being used. To give an idea of what the gpu conversion code looked like before, here is a snippet:</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> KomaCUDAAdaptor <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt_storage</span>(to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">KomaCUDAAdaptor</span>, x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CUDA.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cu</span>(x)</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpu</span>(x)</span>
<span id="cb1-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_use_cuda</span>()</span>
<span id="cb1-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> use_cuda[] ? <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmap</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">KomaCUDAAdaptor</span>(), x), x; exclude<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>_isleaf) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> x</span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#CPU adaptor</span></span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">struct</span> KomaCPUAdaptor <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt_storage</span>(to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">KomaCPUAdaptor</span>, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractArray</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Array</span>, x)</span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt_storage</span>(to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">KomaCPUAdaptor</span>, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">AbstractRange</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cpu</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmap</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">KomaCPUAdaptor</span>(), x), x)</span></code></pre></div>
<p>The <code>fmap</code> function is from the package <code>Functors.jl</code> and can recursively apply a function to a struct tagged with <code>@functor</code>. The function being applied is <code>adapt</code> from <code>Adapt.jl</code>, which will call the lower-level <code>adapt_storage</code> function to actually convert to / from the device type. The second parameter to <code>adapt</code> is what is being adapted, and the first is what it is being adapted to, which in this case is a custom adapter struct <code>KomaCUDAAdapter</code>.</p>
<p>One possible approach to generalize to different backends would be to define additional adapter structs for each backend and corresponding <code>adapt_storage</code> functions. This is what the popular machine learning library <a href="https://github.com/FluxML/Flux.jl">Flux.jl</a> does. However, there is a simpler way!</p>
<p>Each backend package (CUDA.jl, Metal.jl, etc.) already defines <code>adapt_storage</code> functions for converting different types to / from corresponding device type. Reusing these functions is preferable to defining our own since, not only does it save work, but it allows us to rely on the expertise of the developers who wrote those packages! If there is an issue with types being converted incorrectly that is fixed in one of those packages, then we would not need to update our code to get this fix since we are using the definitions they created.</p>
<p>Our final <code>gpu</code> and <code>cpu</code> functions are very simple. The <code>backend</code> parameter is a type derived from the abstract <code>Backend</code> type of <a href="https://github.com/JuliaGPU/KernelAbstractions.jl"><code>KernelAbstractions.jl</code></a>, which is extended by each of the backend packages:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">KernelAbstractions</span> as KA</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gpu</span>(x, backend<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">KA.GPU</span>)</span>
<span id="cb2-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmap</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt</span>(backend, x), x; exclude<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>_isleaf)</span>
<span id="cb2-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cpu</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fmap</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adapt</span>(KA.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CPU</span>(), x), x, exclude<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>_isleaf)</span></code></pre></div>
<p>The other work needed to generalize our GPU support involved switching to use <a href="https://pkgdocs.julialang.org/v1/creating-packages/#Conditional-loading-of-code-in-packages-(Extensions)">package extensions</a> to avoid having each of the backend packages as an explicit dependency, and defining some basic GPU functions for backend selection and printing information about available GPU devices. The pull request for adding support for multiple backends is linked below:</p>
<blockquote class="blockquote">
<p>https://github.com/JuliaHealth/KomaMRI.jl/pull/405</p>
</blockquote>
</section>
<section id="step-2-buildkite-ci" class="level1">
<h1>Step 2: Buildkite CI</h1>
<p>At the time the above pull request was merged, we weren’t sure whether the added support for AMD and Intel GPUs actually worked, since we only had access to CUDA and Apple Silicon GPUs. So the next step was to set up a CI to test each GPU backend. To do this, we used <a href="https://github.com/JuliaGPU/KernelAbstractions.jl">Buildkite</a>, which is a CI platform that many other Julia packages also use. Since there were many examples to follow, setting up our testing pipeline was not too difficult. Each step of the pipeline does the required environment setup and then calls <code>Pkg.test()</code> for KomaMRICore. As an example, here is what the AMDGPU step of our pipeline looks like:</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource {yml} number-lines code-with-copy"><code class="sourceCode"><span id="cb3-1">      - label: "AMDGPU: Run tests on v{{matrix.version}}"</span>
<span id="cb3-2">        matrix:</span>
<span id="cb3-3">          setup:</span>
<span id="cb3-4">            version:</span>
<span id="cb3-5">              - "1"</span>
<span id="cb3-6">        plugins:</span>
<span id="cb3-7">          - JuliaCI/julia#v1:</span>
<span id="cb3-8">              version: "{{matrix.version}}"</span>
<span id="cb3-9">          - JuliaCI/julia-coverage#v1:</span>
<span id="cb3-10">              codecov: true</span>
<span id="cb3-11">              dirs:</span>
<span id="cb3-12">                - KomaMRICore/src</span>
<span id="cb3-13">                - KomaMRICore/ext</span>
<span id="cb3-14">        command: |</span>
<span id="cb3-15">          julia -e 'println("--- :julia: Instantiating project")</span>
<span id="cb3-16">              using Pkg</span>
<span id="cb3-17">              Pkg.develop([</span>
<span id="cb3-18">                  PackageSpec(path=pwd(), subdir="KomaMRIBase"),</span>
<span id="cb3-19">                  PackageSpec(path=pwd(), subdir="KomaMRICore"),</span>
<span id="cb3-20">              ])'</span>
<span id="cb3-21">          </span>
<span id="cb3-22">          julia --project=KomaMRICore/test -e 'println("--- :julia: Add AMDGPU to test environment")</span>
<span id="cb3-23">              using Pkg</span>
<span id="cb3-24">              Pkg.add("AMDGPU")'</span>
<span id="cb3-25">          </span>
<span id="cb3-26">          julia -e 'println("--- :julia: Running tests")</span>
<span id="cb3-27">              using Pkg</span>
<span id="cb3-28">              Pkg.test("KomaMRICore"; coverage=true, test_args=["AMDGPU"])'</span>
<span id="cb3-29">        agents:</span>
<span id="cb3-30">          queue: "juliagpu"</span>
<span id="cb3-31">          rocm: "*"</span>
<span id="cb3-32">        timeout_in_minutes: 60</span></code></pre></div>
<p>We also decided that in addition to a testing CI, it would also be helpful to have a benchmarking CI to track performance changes resulting from each commit to the main branch of the repository. <a href="https://github.com/LuxDL/Lux.jl">Lux.jl</a> had a very nice-looking benchmarking page, so I decided to look into their approach. They were using <a href="https://github.com/benchmark-action/github-action-benchmark">github-action-benchmark</a>, a popular benchmarking action that integrates with the Julia package <a href="https://github.com/JuliaCI/BenchmarkTools.jl"><code>BenchmarkTools.jl</code></a>. github-action-benchmark does two very useful things:</p>
<ol type="1">
<li><p>Collects benchmarking data into a json file and provides a default index.html to display this data. If put inside a relative path in the gh-pages branch of a repository, this results in a public benchmarking page which is automatically updated after each commit!</p></li>
<li><p>Comments on a pull request with the benchmarking results compared with before the pull request. Example: https://github.com/JuliaHealth/KomaMRI.jl/pull/442#pullrequestreview-2213921334</p></li>
</ol>
<p>The only issue was that since github-action-benchmark is a github action, it is meant to be run within github by one of the available github runners. While this works for CPU benchmarking, only Buildkite has the CI setup for each of the GPU backends we are using, and Lux.jl’s benchmarks page only included CPU benchmarks, not GPU benchmarks (Note: we talked with Avik, the repository owner of Lux.jl, and Lux.jl has since adopted the approach outlined below to display GPU and CPU benchmarks together). I was not able to find any examples of other julia packages using github-action-benchmark for GPU benchmarking.</p>
<p>Fortunately, there is a tool someone developed to download results from Buildkite into a github action (https://github.com/EnricoMi/download-buildkite-artifact-action). This repository only had 1 star when I found it, but it does exactly what we needed: it identifies the corresponding Buildkite build for a commit, waits for it to finish, and then downloads the artifacts for the build into the github action it is being run from. With this, we were able to download the Buildkite benchmark results from a final aggregation step into our benchmarking action and upload to github-action-benchmark to publish to either the main data.js file for our benchmarking website, or pull request.</p>
<p>Our final benchmarking page looks like this and is <a href="https://juliahealth.org/KomaMRI.jl/benchmarks/">publicly accessible</a>:</p>
<p><img src="https://juliahealth.org/JuliaHealthBlog/posts/ryan-gsoc/Benchmark_Page.png" class="img-fluid"></p>
<p>One neat thing about github-action-benchmark is that the default index.html is extensible, so even though by deault it only shows time, the information for memory usage and number of allocations is also collected into the json file, and can be displayed as well.</p>
<p>A successful CI run on Buildkite Looks like <a href="https://buildkite.com/julialang/komamri-dot-jl/builds/925">this</a>:</p>
<p><img src="https://juliahealth.org/JuliaHealthBlog/posts/ryan-gsoc/CI_Run.png" class="img-fluid"></p>
<p>The pull requests for creating the CI testing and benchmarking pipeline, and changing the index.html for our benchmark page are listed below:</p>
<ol type="1">
<li>https://github.com/JuliaHealth/KomaMRI.jl/pull/411</li>
<li>https://github.com/JuliaHealth/KomaMRI.jl/pull/418</li>
<li>https://github.com/JuliaHealth/KomaMRI.jl/pull/421</li>
</ol>
</section>
<section id="step-3-optimization" class="level1">
<h1>Step 3: Optimization</h1>
<p>With support for multiple backends enabled, and a robust CI, the next step was to optimize our simulation code as much as possible. Our original idea was to create a new GPU-optimized simulation method, but before doing this we wanted to look more at the existing code and optimize for the CPU.</p>
<p>The simulation code is solving a differential equation (the [Bloch equations(https://en.wikipedia.org/wiki/Bloch_equations)]) over time. Most differential equation solvers step through time, updating the current state at each time step, but our previous simulation code, more optimized for the GPU, did a lot of computations across all time points in a simulation block, allocating a matrix of size <code>Nspins by NΔt</code> each time this was done. Although this is beneficial for the GPU, where there are millions of threads available on which to parallelize these computations, for the CPU it is more important to conserve memory, and the aforementioned approach of stepping through time is preferable.</p>
<p>After seeing that this approach did help speed up simulation time on the CPU, but was not faster on the GPU (7x slower for Metal!) we decided to separate our simulation code for the GPU and CPU, dispatching based on the <code>KernelAbstractions.Backend</code> type depending on if it is <code>&lt;:KernelAbstractions.CPU</code> or <code>&lt;:KernelAbstractions.GPU</code>.</p>
<p>Other things we were able to do to speed up CPU computation time:</p>
<ol type="1">
<li><p>Preallocating each array used inside the core simulation code so it can be re-used from one simulation block to the next.</p></li>
<li><p><a href="https://github.com/JuliaHealth/KomaMRI.jl/blob/master/KomaMRICore/src/simulation/SimMethods/Bloch/BlochCPU.jl#L90">Skipping an expensive computation</a> if the magnetization at that time point is not added to the final signal</p></li>
<li><p>Ensuring that each statement is fully broadcasted. We were surprised to see the difference between the following examples:</p></li>
</ol>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Fast</span></span>
<span id="cb4-2">Bz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> seq.Gx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> seq.Gy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> seq.Gz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> p.Δw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">./</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">T</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>π <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> γ)</span>
<span id="cb4-3"></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Slow</span></span>
<span id="cb4-5">Bz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> seq.Gx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> seq.Gy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> seq.Gz<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> p.Δw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">T</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>π <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> γ)</span></code></pre></div>
<ol start="4" type="1">
<li>Using the <code>cis</code> function for complex exponentiation, which is faster than <code>exp</code></li>
</ol>
<p>With these changes, the mean improvement in simulation time aggregating across each of our benchmarks for 1, 2, 4, and 8 CPU threads was ~4.28. For 1 thread, the average improvement in memory usage was 90x!</p>
<p>The next task was optimizing the simulation code for the GPU. Although our original idea was to put everything into one GPU kernel, we found that the existing broadcasting operations were already very fast, and that custom kernels we wrote were not able to outperform the previous implementation. The Julia GPU compiler team deserves a lot of credit for developing such fast broadcasting implementations!</p>
<p>However, this does not mean that we were unable to improve the GPU simulation time. Similar to with the CPU, preallocation made a substantial difference. Parallelizing as much work as possible across the time points for a simulation block was also found to beneficial. For the parts that needed to be done sequentially, a <a href="https://github.com/JuliaHealth/KomaMRI.jl/blob/master/KomaMRICore/src/simulation/SimMethods/Bloch/KernelFunctions.jl#L5">custom GPU kernel</a> was written which used the <code>KernelAbstractions.@localmem</code> macro for arrays being updated at each time step to yield faster memory access.</p>
<p>The mean speedup we saw across the 4 supported GPU backends was 4.16, although this varied accross each backend (for example, CUDA was only 2.66x faster while oneAPI was 28x faster). There is a <a href="https://github.com/JuliaHealth/KomaMRI.jl/blob/master/KomaMRICore/src/simulation/SimMethods/Bloch/BlochGPU.jl#L151">remaining bottleneck</a> in the <code>run_spin_preceession!</code> function having to do with logical indexing that I was not able to resolve, but could be solved in the future to speed up the GPU simulation time even further!</p>
<p>The pull requests optimizing code for the CPU and GPU are below:</p>
<ol type="1">
<li><p>https://github.com/JuliaHealth/KomaMRI.jl/pull/443</p></li>
<li><p>https://github.com/JuliaHealth/KomaMRI.jl/pull/459</p></li>
<li><p>https://github.com/JuliaHealth/KomaMRI.jl/pull/462</p></li>
</ol>
</section>
<section id="step-4-distributed-support" class="level1">
<h1>4. Step 4: Distributed Support</h1>
<p>This last step was a stretch goal for exploring how to add distributed support to KomaMRI. MRI simulations can become quite large, so it is useful to be able to distribute work across either multiple GPUs or multiple compute nodes.</p>
<p>A nice thing about MRI simulation is the independent spin property: if a phantom object (representing, for example a brain tissue slice) is divided into two parts, and each part is simulated separately, the signal result from simulating the whole phantom will be equal to the sum of the signal results from simulating each subdivision of the original phantom. This makes it quite easy to distribute work, either across more than one GPU or accross multiple compute nodes.</p>
<p>The following scripts worked, with the only necessary code change to the repository being a new + function to add two RawAcquisitionData structs:</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Use multiple GPUs:</span></span>
<span id="cb5-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributed</span></span>
<span id="cb5-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CUDA</span></span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Add workers based on the number of available devices</span></span>
<span id="cb5-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addprocs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">devices</span>()))</span>
<span id="cb5-7"></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Define inputs on each worker process</span></span>
<span id="cb5-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@everywhere</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb5-10">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">KomaMRI</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">CUDA</span></span>
<span id="cb5-11">    sys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Scanner</span>()</span>
<span id="cb5-12">    seq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PulseDesigner.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EPI_example</span>()</span>
<span id="cb5-13">    obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brain_phantom2D</span>()</span>
<span id="cb5-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Divide phantom</span></span>
<span id="cb5-15">    parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kfoldperm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(obj), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nworkers</span>())</span>
<span id="cb5-16"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb5-17"></span>
<span id="cb5-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Distribute simulation across workers</span></span>
<span id="cb5-19">raw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributed</span>.<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@distributed</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nworkers</span>()</span>
<span id="cb5-20">    KomaMRICore.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_device!</span>(i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Sets device for this worker, note that CUDA devices are indexed from 0</span></span>
<span id="cb5-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate</span>(obj[parts[i]], seq, sys)</span>
<span id="cb5-22"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Use multiple compute nodes</span></span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributed</span></span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ClusterManagers</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Add workers based on the specified number of SLURM tasks</span></span>
<span id="cb6-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">addprocs</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">SlurmManager</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse</span>(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Int</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">ENV</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SLURM_NTASKS"</span>])))</span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Define inputs on each worker process</span></span>
<span id="cb6-9"><span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@everywhere</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">begin</span></span>
<span id="cb6-10">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">KomaMRI</span></span>
<span id="cb6-11">    sys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Scanner</span>()</span>
<span id="cb6-12">    seq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PulseDesigner.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EPI_example</span>()</span>
<span id="cb6-13">    obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brain_phantom2D</span>()</span>
<span id="cb6-14">    parts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kfoldperm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(obj), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nworkers</span>())</span>
<span id="cb6-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span>
<span id="cb6-16"></span>
<span id="cb6-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Distribute simulation across workers</span></span>
<span id="cb6-18">raw <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributed</span>.<span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@distributed</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nworkers</span>()</span>
<span id="cb6-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate</span>(obj[parts[i]], seq, sys)</span>
<span id="cb6-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">end</span></span></code></pre></div>
<p>Pull reqeust for adding these examples to the KomaMRI documentation: https://github.com/JuliaHealth/KomaMRI.jl/pull/468</p>
</section>
<section id="conclusions-future-work" class="level1">
<h1>Conclusions / Future Work</h1>
<p>This project was a 350-hour large project, since there were many goals to accomplish. To summarize what changed since the beginning of the project:</p>
<ol type="1">
<li><p>Added support for AMDGPU.jl, Metal.jl, and oneAPI.jl GPU backends</p></li>
<li><p>CI for automated testing and benchmarking accross each backend + <a href="https://juliahealth.org/KomaMRI.jl/benchmarks/">public benchmarks page</a></p></li>
<li><p>Significantly faster CPU and GPU performance</p></li>
<li><p>Demonstrated distributed support and examples added in documentation</p></li>
</ol>
<p>Future work could look at ways to further optimize the simulation code, since despite the progress made, I believe there is more work to be done! The aforementioned logical indexing issue is still not resolved, and the kernel used inside the <code>run_spin_excitation!</code> function has not been profiled in depth. KomaMRI is also looking into adding support for higher-order ODE methods, which could require more GPU kernels being written.</p>
</section>
<section id="acknowledgements" class="level1">
<h1>Acknowledgements</h1>
<p>I would like to thank my mentor, Carlos Castillo, for his help and support on this project. I would also like to thank Jakub Mitura, who attended some of our meetings to help with GPU optimization, Dilum Aluthge who helped set up our BuildKite pipeline, and Tim Besard, who answered many GPU-related questions that Carlos and I had.</p>


<!-- -->

</section>

<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{kierulf2024,
  author = {Kierulf, Ryan},
  title = {GSoC ’24: {Enhancements} to {KomaMRI.jl} {GPU} {Support}},
  date = {2024-08-30},
  url = {https://juliahealth.org/JuliaHealthBlog/posts/ryan-gsoc/Ryan_GSOC.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-kierulf2024" class="csl-entry quarto-appendix-citeas">
Kierulf, Ryan. 2024. <span>“GSoC ’24: Enhancements to KomaMRI.jl GPU
Support.”</span> August 30, 2024. <a href="https://juliahealth.org/JuliaHealthBlog/posts/ryan-gsoc/Ryan_GSOC.html">https://juliahealth.org/JuliaHealthBlog/posts/ryan-gsoc/Ryan_GSOC.html</a>.
</div></div></section></div> ]]></description>
  <category>gsoc</category>
  <category>mri</category>
  <category>gpu</category>
  <category>hpc</category>
  <category>simulation</category>
  <guid>https://juliahealth.org/JuliaHealthBlog/posts/ryan-gsoc/Ryan_GSOC.html</guid>
  <pubDate>Fri, 30 Aug 2024 04:00:00 GMT</pubDate>
</item>
<item>
  <title>GSoC ’24: IPUMS.jl Small Project</title>
  <dc:creator>Michela Rocchetti</dc:creator>
  <link>https://juliahealth.org/JuliaHealthBlog/posts/michela-gsoc/Michela_JSoC.html</link>
  <description><![CDATA[ 




<section id="hello" class="level1">
<h1>Hello! 👋</h1>
<p>Hi! I am Michela, I have a Master’s degree in Physics of Complex Systems and I am currently working as a software engineer in Rome, where I am from. During my studies, I became interested in the use of modeling and AI methods to improve healthcare and how these tools can be used to better understand how cultural and social backgrounds influence the health of individuals. I am also interested in the computational modeling of the brain and the human body and its implications for a better understanding of certain pathological conditions.</p>
<p>With these motivations in mind, I heard about Google Summer of Code. Since I had studied Julia in some courses and given that the language is expanding rapidly, I decided to find a project within Julia. As a result, I found the project of <a href="https://jacobzelko.com">Jacob Zelko (<span class="citation" data-cites="TheCedarPrince">@TheCedarPrince</span>)</a> to start this experience.</p>
<blockquote class="blockquote">
<p>If you want to learn more about me, you can connect with me here: <a href="https://www.linkedin.com/in/michela-rocchetti-261793218/"><strong>LinkedIn</strong></a>, <a href="https://github.com/MichelaRocchetti"><strong>GitHub</strong></a></p>
</blockquote>
</section>
<section id="project-description" class="level1">
<h1>Project Description</h1>
<p><em>IPUMS</em> is the “world’s largest available single database of census microdata”, providing survey and census data from around the world. It includes several projects that provide a wide variety of datasets. The information and data collected by <em>IPUMS</em> are useful for comparative research, as well as for the analysis of individuals in their life contexts. These data can be used to create a more comprehensive dataset that will facilitate research on the social determinants of health for different types of diseases, social communities, and geographical areas.</p>
<p><img src="https://juliahealth.org/JuliaHealthBlog/posts/michela-gsoc/IPUMS_grid_logo.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>To learn more about IPUMS, visit the <a href="https://www.ipums.org">website</a></p>
</blockquote>
</section>
<section id="tasks-and-goals" class="level1">
<h1>Tasks and Goals</h1>
<p>The primary objectives of this proposal are to:</p>
<ol type="1">
<li><p>Develop a native Julia package to interact with the APIs available around the datasets <em>IPUMS</em> provides.</p></li>
<li><p>Provide useful utilities within this package for manipulating <em>IPUMS</em> datasets.</p></li>
<li><p>Compose this package with the wider Julia ecosystem to enable novel research in health, economics, and more.</p></li>
</ol>
<p>To achieve this, the work was distributed as follows:</p>
<ol type="1">
<li>Expand some of the functionality developed in <code>ipumsr</code> <em>IPUMS</em> NHGIS
<ul>
<li>Create a link between OpenAPI documentation and the functions internally used in IPUMS.jl: updating already present functions, determining if updating is needed, and testing them</li>
<li>Develop functionality similar to the get_metadata_nghis function present in ipumsr</li>
</ul></li>
<li>Update <em>IPUMS</em> documentation
<ul>
<li>Set up and deploy DocumenterVitepress.jl<br>
</li>
<li>Write a blog post on how IPUMS.jl can be composed within the ecosystem.</li>
</ul></li>
</ol>
</section>
<section id="how-the-work-was-done" class="level1">
<h1>How the work was done</h1>
<p>The first task was to migrate documents from Documenter to DocumenterVitepress.This issue aims to support the significant refactoring underway across JuliaHealth, aimed at improving the discoverability and cohesion of the JuliaHealth ecosystem, particularly about documentation. This issue is intended to create a more attractive entry point for new Julia users interested in health research within the Julia community. To accomplish this task, a dependency of DocumenterVitepress was added to the docs directory of the IPUMS.jl repository. Once this was done, the Documenter.jl make.jl file was migrated into a DocumenterVitepress.jl make.jl file. Working on the make.jl file, the pages structure were added to the web page explaining the IPUMS.jl package. With this in mind, those were added: 1. Home: to explain the main purpose of the package 2. Workflows: to explain the working process 3. How to: to give general information 4. Tutorials: to show how to use IPUMS.jl<br>
5. Examples: some examples of activities 6. Mission: to explain why the package is useful for the community 7. References: references used to write the pages.</p>
<p>This first task takes some time, especially setting up GitHub and cloning the repository locally. At this point, my experience with GitHub was really limited and I had to learn how to use the Git environment from scratch, for example how to do continuous integration (to commit code to a shared repository), documentation release and merge, and local testing. I found the support of my mentors and searching for material online was really helpful.</p>
<p>The second task was to update the documentation of IPUMS.jl by modifying the functionality within the model folder in the IPUMS.jl folder. The main aim of this task was to a description of the function and its attributes, an example of possible implementation and result, and finally to show how to use it. The documentation to be updated as of several types of functions: 1. Data extract 2. Data set 3. Data Table 4. Time series table 5. Error 6. Shapefile. Each of these macro-categories (from 1 to 4) contains a set of functions, each signaling the different expected output and specific purpose. Information about what each function does, and the meaning of each specific input variable, has been found on the <em>IPUMS</em> website and references have been made in the written documentation.</p>
</section>
<section id="how-to-work-with-ipums" class="level1">
<h1>How to work with IPUMS</h1>
<p>After writing down the description of the function and the inputs, examples were formulated, starting from the <em>IPUMS</em> website: when you register at <a href="https://uma.pop.umn.edu/usa/user/new">IPUMS</a>, an API key is given. which is used, among other things, to run pre-written code on the website. This code contains examples of these functions, and these examples have been adapted by changing some input values and adapting them to work in the Julia framework. The latter task was done by simply rewriting some structures, such as dictionaries, maps, or lists, in the Julia language. Here is a small guide on how to set up working with the API: 1. Create an <em>IPUMS</em> account 2. Log in to your account 3. Copy the API key, which can be obtained from the <a href="https://account.ipums.org/api_keys">website</a> 4. Use the key to run the code that is already available on the <a href="https://developer.ipums.org/docs/v2/reference/"><em>IPUMS</em> Developer Portal</a>, where you will also find information about the variables and packages.</p>
</section>
<section id="functions-testing" class="level1">
<h1>Functions testing</h1>
<p>A final task was to test the functions in the ‘api_IPUMSAPI.jl’ file. In this file, the function to be tested and other functions are defined and the most important ones are extracted to be available in the available throughout the framework. Some of the functions to be tested were the following:</p>
<ol type="1">
<li><code>metadata_nhgis_data_tables_get</code></li>
<li><code>metadata_nhgis_datasets_dataset_data_tables_data_table_get</code></li>
<li><code>metadata_nhgis_datasets_dataset_get</code></li>
<li><code>metadata_nhgis_datasets_get</code></li>
</ol>
<p>Before working on the Julia files, testing and understanding the original R function was done using R studio.</p>
<p><img src="https://juliahealth.org/JuliaHealthBlog/posts/michela-gsoc/rstudio.png" class="img-fluid"></p>
<p>Each function was then tested using the API key from the <em>IPUMS</em> registration as well as other input examples taken from the documentation or the <em>IPUMS</em> website. or from the <em>IPUMS</em> website. All functions were displayed successfully, giving the expected result, so it can be concluded that the translation from R to Julia is successful.</p>
<div id="2" class="cell" data-execution_count="0">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">IPUMS</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">OpenAPI</span></span>
<span id="cb1-3"></span>
<span id="cb1-4">api_key <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"insert your key here"</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">version <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span></span>
<span id="cb1-7">page_number <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-8">page_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2500</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#media_type = </span></span>
<span id="cb1-10"></span>
<span id="cb1-11">api <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">IPUMSAPI</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.ipums.org"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dict</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Authorization"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> api_key));</span>
<span id="cb1-12"></span>
<span id="cb1-13">res1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metadata_nhgis_data_tables_get</span>(api, version)</span>
<span id="cb1-14"></span>
<span id="cb1-15">res2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metadata_nhgis_datasets_dataset_get</span>(api, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2022_ACS1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span>);</span>
<span id="cb1-16"></span>
<span id="cb1-17">res3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metadata_nhgis_datasets_dataset_data_tables_data_table_get</span>(api, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2022_ACS1"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B01001"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span>);</span>
<span id="cb1-18"></span>
<span id="cb1-19">res4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">metadata_nhgis_datasets_get</span>(api, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span>);</span></code></pre></div>
</details>
</div>
<p>An example of the output is:</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource {json} number-lines code-with-copy"><code class="sourceCode"><span id="cb2-1">. . .</span>
<span id="cb2-2"></span>
<span id="cb2-3">{</span>
<span id="cb2-4">  "name": "NT1",</span>
<span id="cb2-5">  "nhgisCode": "AAA",</span>
<span id="cb2-6">  "description": "Total Population",</span>
<span id="cb2-7">  "universe": "Persons",</span>
<span id="cb2-8">  "sequence": 1,</span>
<span id="cb2-9">  "datasetName": "1790_cPop",</span>
<span id="cb2-10">  "nVariables": [</span>
<span id="cb2-11">    1</span>
<span id="cb2-12">  ]</span>
<span id="cb2-13">}</span>
<span id="cb2-14"></span>
<span id="cb2-15">. . .</span></code></pre></div>
</section>
<section id="accomplished-goals-and-future-development" class="level1">
<h1>Accomplished Goals and Future Development</h1>
<p>The project was a 90-hour small project and during this time the documentation was completed and the testing of the metadata function was done, as well as the migration from Documenter.jl to DocumenterVitepress.jl. During these months some things took longer than I expected because of some problems that occurred, so some things were missing in relation to the original plan. However, this time was useful for learning new things: - I saw how to work with a package under development, how to work with large datasets, and how to write documentation - I had the opportunity to better understand how to work with Git and GitHub - I learned some new things about R, which was a completely unknown language to me. - I deepened my knowledge of Julia, a language I had worked with during my time at university. - I had the chance to work on a large open-source project, to be part of a large community, and to learn how to communicate with it efficiently.</p>
<p>A special thanks goes to my mentors, Jacob Zelko and Krishna Bhogaonker, for helping me through this process.</p>
<p>Future developments of this work could include deepening the work that my mentors and I have started, with the possibility of integrating this package with other machine learning packages in Julia and, from there, doing new analyses of the data in terms of social and geographical implications for health.</p>


<!-- -->

</section>

<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{rocchetti2024,
  author = {Rocchetti, Michela},
  title = {GSoC ’24: {IPUMS.jl} {Small} {Project}},
  date = {2024-08-26},
  url = {https://juliahealth.org/JuliaHealthBlog/posts/michela-gsoc/Michela_JSoC.html},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-rocchetti2024" class="csl-entry quarto-appendix-citeas">
Rocchetti, Michela. 2024. <span>“GSoC ’24: IPUMS.jl Small
Project.”</span> August 26, 2024. <a href="https://juliahealth.org/JuliaHealthBlog/posts/michela-gsoc/Michela_JSoC.html">https://juliahealth.org/JuliaHealthBlog/posts/michela-gsoc/Michela_JSoC.html</a>.
</div></div></section></div> ]]></description>
  <category>gsoc</category>
  <category>geospatial</category>
  <category>census</category>
  <guid>https://juliahealth.org/JuliaHealthBlog/posts/michela-gsoc/Michela_JSoC.html</guid>
  <pubDate>Mon, 26 Aug 2024 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Dummy Post</title>
  <dc:creator>Foobar </dc:creator>
  <link>https://juliahealth.org/JuliaHealthBlog/posts/dummy/</link>
  <description><![CDATA[ 




<section id="seciton-1" class="level1">
<h1>Seciton 1</h1>
<p>Small dummy blog post</p>
<div id="2" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>4</code></pre>
</div>
</div>
<div id="4" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource julia number-lines code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">println</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>4</code></pre>
</div>
</div>
</section>
<section id="section-2" class="level1">
<h1>Section 2</h1>
</section>
<section id="section-3" class="level1">
<h1>Section 3</h1>


<!-- -->

</section>

<a onclick="window.scrollTo(0, 0); return false;" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{2024,
  author = {, Foobar},
  title = {Dummy {Post}},
  date = {2024-06-22},
  url = {https://juliahealth.org/JuliaHealthBlog/posts/dummy/},
  langid = {en}
}
</code></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-2024" class="csl-entry quarto-appendix-citeas">
Foobar. 2024. <span>“Dummy Post.”</span> June 22, 2024. <a href="https://juliahealth.org/JuliaHealthBlog/posts/dummy/">https://juliahealth.org/JuliaHealthBlog/posts/dummy/</a>.
</div></div></section></div> ]]></description>
  <category>news</category>
  <category>code</category>
  <category>analysis</category>
  <guid>https://juliahealth.org/JuliaHealthBlog/posts/dummy/</guid>
  <pubDate>Sat, 22 Jun 2024 04:00:00 GMT</pubDate>
</item>
</channel>
</rss>
